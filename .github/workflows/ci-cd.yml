name: CI-CD

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-test:
    name: Build & Test (Maven)
    runs-on: ubuntu-latest
    strategy:
      matrix:
        service:
          - api-gateway
          - auth-service
          - mail-service
          - enrollment-service
          - audit-service
          - java-rabbitMQ-userCorreo # user-service
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '11'

      - name: Cache Maven
        uses: actions/cache@v4
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-maven-${{ hashFiles(format('{0}/pom.xml', matrix.service)) }}
          restore-keys: |
            ${{ runner.os }}-maven-

      - name: Build & Test ${{ matrix.service }}
        run: |
          mvn -B -f ${{ matrix.service }}/pom.xml clean test package

  docker-build-push:
    name: Build & Push Docker Images to ACR
    needs: build-test
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - service: api-gateway
            image: api-gateway
            context: api-gateway
            dockerfile: api-gateway/Dockerfile
          - service: auth-service
            image: auth-service
            context: auth-service
            dockerfile: auth-service/Dockerfile
          - service: mail-service
            image: mail-service
            context: mail-service
            dockerfile: mail-service/Dockerfile
          - service: enrollment-service
            image: enrollment-service
            context: enrollment-service
            dockerfile: enrollment-service/Dockerfile
          - service: audit-service
            image: audit-service
            context: audit-service
            dockerfile: audit-service/Dockerfile
          - service: java-rabbitMQ-userCorreo
            image: user-service
            context: java-rabbitMQ-userCorreo
            dockerfile: java-rabbitMQ-userCorreo/Dockerfile
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Resolve ACR login server
        id: acr
        run: |
          echo "ACR_LOGIN_SERVER=$(az acr show --name ${{ secrets.AZURE_CONTAINER_REGISTRY }} --query loginServer -o tsv)" >> $GITHUB_ENV

      - name: ACR Login
        run: az acr login --name ${{ secrets.AZURE_CONTAINER_REGISTRY }}

      - name: Setup Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build & Push ${{ matrix.image }}
        uses: docker/build-push-action@v6
        with:
          context: ${{ matrix.context }}
          file: ${{ matrix.dockerfile }}
          push: true
          tags: |
            ${{ env.ACR_LOGIN_SERVER }}/${{ matrix.image }}:${{ github.sha }}
            ${{ env.ACR_LOGIN_SERVER }}/${{ matrix.image }}:latest
          platforms: linux/amd64

  deploy-vm:
    name: Deploy to Azure VM (Docker Compose)
    needs: docker-build-push
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Resolve ACR login server
        run: |
          echo "ACR_LOGIN_SERVER=$(az acr show --name ${{ secrets.AZURE_CONTAINER_REGISTRY }} --query loginServer -o tsv)" >> $GITHUB_ENV

      - name: Copy Compose file to VM
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.VM_HOST }}
          username: ${{ secrets.VM_SSH_USER }}
          key: ${{ secrets.VM_SSH_KEY }}
          port: ${{ secrets.VM_SSH_PORT }}
          source: "deploy/docker-compose.vm.yml"
          target: "~/proy17/docker-compose.vm.yml"

      - name: Deploy on VM via SSH
        uses: appleboy/ssh-action@v0.1.19
        with:
          host: ${{ secrets.VM_HOST }}
          username: ${{ secrets.VM_SSH_USER }}
          key: ${{ secrets.VM_SSH_KEY }}
          port: ${{ secrets.VM_SSH_PORT }}
          script: |
            set -e
            mkdir -p ~/proy17
            cd ~/proy17
            echo "ACR_LOGIN_SERVER=${{ env.ACR_LOGIN_SERVER }}" > .env
            echo "TAG=${{ github.sha }}" >> .env
            # Optional SMTP for mail-service
            [ -n "${{ secrets.MAIL_HOST }}" ] && echo "MAIL_HOST=${{ secrets.MAIL_HOST }}" >> .env
            [ -n "${{ secrets.MAIL_PORT }}" ] && echo "MAIL_PORT=${{ secrets.MAIL_PORT }}" >> .env
            [ -n "${{ secrets.MAIL_USERNAME }}" ] && echo "MAIL_USERNAME=${{ secrets.MAIL_USERNAME }}" >> .env
            [ -n "${{ secrets.MAIL_PASSWORD }}" ] && echo "MAIL_PASSWORD=${{ secrets.MAIL_PASSWORD }}" >> .env

            # Login to ACR and pull images
            docker login ${{ env.ACR_LOGIN_SERVER }} -u "${{ secrets.ACR_USERNAME }}" -p "${{ secrets.ACR_PASSWORD }}"

            # Detect docker compose command
            if docker compose version >/dev/null 2>&1; then DC="docker compose"; else DC="docker-compose"; fi

            $DC --env-file .env -f docker-compose.vm.yml pull
            $DC --env-file .env -f docker-compose.vm.yml up -d --remove-orphans

      # ---------------- Auth Service ----------------
      - name: Configure Auth Web App container (ACR image)
        run: |
          az webapp config container set \
            -g "${{ secrets.AZURE_RESOURCE_GROUP }}" \
            -n "${{ secrets.AZURE_WEBAPP_AUTH }}" \
            --docker-custom-image-name "${{ env.ACR_LOGIN_SERVER }}/auth-service:${{ github.sha }}" \
            --docker-registry-server-url "https://${{ env.ACR_LOGIN_SERVER }}" \
            --docker-registry-server-user "${{ secrets.ACR_USERNAME }}" \
            --docker-registry-server-password "${{ secrets.ACR_PASSWORD }}"

      - name: Set Auth app settings (port, profile & PostgreSQL)
        env:
          SPRING_DATASOURCE_URL: ${{ secrets.SPRING_DATASOURCE_URL }}
          SPRING_DATASOURCE_USERNAME: ${{ secrets.SPRING_DATASOURCE_USERNAME }}
          SPRING_DATASOURCE_PASSWORD: ${{ secrets.SPRING_DATASOURCE_PASSWORD }}
          SPRING_DATASOURCE_DRIVER_CLASS_NAME: ${{ secrets.SPRING_DATASOURCE_DRIVER_CLASS_NAME }}
          SPRING_JPA_HIBERNATE_DDL_AUTO: ${{ secrets.SPRING_JPA_HIBERNATE_DDL_AUTO }}
          SPRING_JPA_DATABASE_PLATFORM: ${{ secrets.SPRING_JPA_DATABASE_PLATFORM }}
          APP_API_KEY: ${{ secrets.APP_API_KEY }}
        run: |
          SETTINGS="WEBSITES_PORT=9101 SPRING_PROFILES_ACTIVE=docker"
          [ -n "$SPRING_DATASOURCE_URL" ] && SETTINGS="$SETTINGS SPRING_DATASOURCE_URL=$SPRING_DATASOURCE_URL"
          [ -n "$SPRING_DATASOURCE_USERNAME" ] && SETTINGS="$SETTINGS SPRING_DATASOURCE_USERNAME=$SPRING_DATASOURCE_USERNAME"
          [ -n "$SPRING_DATASOURCE_PASSWORD" ] && SETTINGS="$SETTINGS SPRING_DATASOURCE_PASSWORD=$SPRING_DATASOURCE_PASSWORD"
          [ -n "$SPRING_DATASOURCE_DRIVER_CLASS_NAME" ] && SETTINGS="$SETTINGS SPRING_DATASOURCE_DRIVER_CLASS_NAME=$SPRING_DATASOURCE_DRIVER_CLASS_NAME"
          [ -n "$SPRING_JPA_HIBERNATE_DDL_AUTO" ] && SETTINGS="$SETTINGS SPRING_JPA_HIBERNATE_DDL_AUTO=$SPRING_JPA_HIBERNATE_DDL_AUTO"
          [ -n "$SPRING_JPA_DATABASE_PLATFORM" ] && SETTINGS="$SETTINGS SPRING_JPA_DATABASE_PLATFORM=$SPRING_JPA_DATABASE_PLATFORM"
          [ -n "$APP_API_KEY" ] && SETTINGS="$SETTINGS APP_API_KEY=$APP_API_KEY"
          az webapp config appsettings set \
            -g "${{ secrets.AZURE_RESOURCE_GROUP }}" \
            -n "${{ secrets.AZURE_WEBAPP_AUTH }}" \
            --settings $SETTINGS

      - name: Restart Auth Web App
        run: az webapp restart -g "${{ secrets.AZURE_RESOURCE_GROUP }}" -n "${{ secrets.AZURE_WEBAPP_AUTH }}"

      # ---------------- User Service ----------------
      - name: Configure User Web App container (ACR image)
        run: |
          az webapp config container set \
            -g "${{ secrets.AZURE_RESOURCE_GROUP }}" \
            -n "${{ secrets.AZURE_WEBAPP_USER }}" \
            --docker-custom-image-name "${{ env.ACR_LOGIN_SERVER }}/user-service:${{ github.sha }}" \
            --docker-registry-server-url "https://${{ env.ACR_LOGIN_SERVER }}" \
            --docker-registry-server-user "${{ secrets.ACR_USERNAME }}" \
            --docker-registry-server-password "${{ secrets.ACR_PASSWORD }}"

      - name: Set User app settings (port, profile, API URL & integrations)
        env:
          AZURE_WEBAPP_NAME: ${{ secrets.AZURE_WEBAPP_NAME }}
          SPRING_KAFKA_BOOTSTRAP_SERVERS: ${{ secrets.KAFKA_BOOTSTRAP_SERVERS }}
          APP_KAFKA_ENABLED: ${{ secrets.APP_KAFKA_ENABLED }}
          SPRING_RABBITMQ_HOST: ${{ secrets.RABBITMQ_HOST }}
          SPRING_RABBITMQ_PORT: ${{ secrets.RABBITMQ_PORT }}
          SPRING_RABBITMQ_USERNAME: ${{ secrets.RABBITMQ_USER }}
          SPRING_RABBITMQ_PASSWORD: ${{ secrets.RABBITMQ_PASS }}
          APP_RABBITMQ_EXCHANGE: ${{ secrets.RABBITMQ_EXCHANGE }}
          APP_RABBITMQ_QUEUE: ${{ secrets.RABBITMQ_QUEUE }}
          APP_RABBITMQ_ROUTINGKEY: ${{ secrets.RABBITMQ_ROUTING_KEY }}
          SPRING_DATASOURCE_URL: ${{ secrets.SPRING_DATASOURCE_URL }}
          SPRING_DATASOURCE_USERNAME: ${{ secrets.SPRING_DATASOURCE_USERNAME }}
          SPRING_DATASOURCE_PASSWORD: ${{ secrets.SPRING_DATASOURCE_PASSWORD }}
          SPRING_DATASOURCE_DRIVER_CLASS_NAME: ${{ secrets.SPRING_DATASOURCE_DRIVER_CLASS_NAME }}
          SPRING_JPA_HIBERNATE_DDL_AUTO: ${{ secrets.SPRING_JPA_HIBERNATE_DDL_AUTO }}
          SPRING_JPA_DATABASE_PLATFORM: ${{ secrets.SPRING_JPA_DATABASE_PLATFORM }}
        run: |
          ENROLLMENTS_API="https://${AZURE_WEBAPP_NAME}.azurewebsites.net/api/enrollments"
          SETTINGS="WEBSITES_PORT=9100 SPRING_PROFILES_ACTIVE=docker APP_ENROLLMENTS_API=$ENROLLMENTS_API"
          [ -n "$SPRING_KAFKA_BOOTSTRAP_SERVERS" ] && SETTINGS="$SETTINGS SPRING_KAFKA_BOOTSTRAP_SERVERS=$SPRING_KAFKA_BOOTSTRAP_SERVERS"
          [ -n "$APP_KAFKA_ENABLED" ] && SETTINGS="$SETTINGS APP_KAFKA_ENABLED=$APP_KAFKA_ENABLED"
          [ -n "$SPRING_RABBITMQ_HOST" ] && SETTINGS="$SETTINGS SPRING_RABBITMQ_HOST=$SPRING_RABBITMQ_HOST"
          [ -n "$SPRING_RABBITMQ_PORT" ] && SETTINGS="$SETTINGS SPRING_RABBITMQ_PORT=$SPRING_RABBITMQ_PORT"
          [ -n "$SPRING_RABBITMQ_USERNAME" ] && SETTINGS="$SETTINGS SPRING_RABBITMQ_USERNAME=$SPRING_RABBITMQ_USERNAME"
          [ -n "$SPRING_RABBITMQ_PASSWORD" ] && SETTINGS="$SETTINGS SPRING_RABBITMQ_PASSWORD=$SPRING_RABBITMQ_PASSWORD"
          [ -n "$APP_RABBITMQ_EXCHANGE" ] && SETTINGS="$SETTINGS APP_RABBITMQ_EXCHANGE=$APP_RABBITMQ_EXCHANGE"
          [ -n "$APP_RABBITMQ_QUEUE" ] && SETTINGS="$SETTINGS APP_RABBITMQ_QUEUE=$APP_RABBITMQ_QUEUE"
          [ -n "$APP_RABBITMQ_ROUTINGKEY" ] && SETTINGS="$SETTINGS APP_RABBITMQ_ROUTINGKEY=$APP_RABBITMQ_ROUTINGKEY"
          [ -n "$SPRING_DATASOURCE_URL" ] && SETTINGS="$SETTINGS SPRING_DATASOURCE_URL=$SPRING_DATASOURCE_URL"
          [ -n "$SPRING_DATASOURCE_USERNAME" ] && SETTINGS="$SETTINGS SPRING_DATASOURCE_USERNAME=$SPRING_DATASOURCE_USERNAME"
          [ -n "$SPRING_DATASOURCE_PASSWORD" ] && SETTINGS="$SETTINGS SPRING_DATASOURCE_PASSWORD=$SPRING_DATASOURCE_PASSWORD"
          [ -n "$SPRING_DATASOURCE_DRIVER_CLASS_NAME" ] && SETTINGS="$SETTINGS SPRING_DATASOURCE_DRIVER_CLASS_NAME=$SPRING_DATASOURCE_DRIVER_CLASS_NAME"
          [ -n "$SPRING_JPA_HIBERNATE_DDL_AUTO" ] && SETTINGS="$SETTINGS SPRING_JPA_HIBERNATE_DDL_AUTO=$SPRING_JPA_HIBERNATE_DDL_AUTO"
          [ -n "$SPRING_JPA_DATABASE_PLATFORM" ] && SETTINGS="$SETTINGS SPRING_JPA_DATABASE_PLATFORM=$SPRING_JPA_DATABASE_PLATFORM"
          az webapp config appsettings set \
            -g "${{ secrets.AZURE_RESOURCE_GROUP }}" \
            -n "${{ secrets.AZURE_WEBAPP_USER }}" \
            --settings $SETTINGS

      - name: Restart User Web App
        run: az webapp restart -g "${{ secrets.AZURE_RESOURCE_GROUP }}" -n "${{ secrets.AZURE_WEBAPP_USER }}"