name: CI-CD

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build-test:
    name: Build & Test (Maven)
    runs-on: ubuntu-latest
    strategy:
      matrix:
        service:
          - api-gateway
          - auth-service
          # - mail-service
          - enrollment-service
          - audit-service
          # user-service omitido
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '11'

      - name: Cache Maven
        uses: actions/cache@v4
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-maven-${{ hashFiles(format('{0}/pom.xml', matrix.service)) }}
          restore-keys: |
            ${{ runner.os }}-maven-

      - name: Build & Test ${{ matrix.service }}
        working-directory: ${{ matrix.service }}
        run: |
          echo "Working dir: $(pwd)"
          ls -la
          if [ -f pom.xml ]; then
            mvn -B clean test package
          else
            echo "pom.xml not found here. Skipping Maven build for ${{ matrix.service }}."
          fi

  docker-build-push:
    name: Build & Push Docker Images to ACR
    needs: build-test
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - service: api-gateway
            image: api-gateway
            context: api-gateway
          - service: auth-service
            image: auth-service
            context: auth-service
          - service: auth-service
            image: auth-service
            context: auth-service
          # - service: mail-service
          #   image: mail-service
          #   context: mail-service
          - service: enrollment-service
            image: enrollment-service
            context: enrollment-service
          - service: enrollment-webapp
            image: enrollment-webapp
            context: enrollment-webapp
          - service: audit-service
            image: audit-service
            context: audit-service
          # user-service omitido
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Resolve ACR login server
        id: acr
        run: |
          echo "ACR_LOGIN_SERVER=$(az acr show --name ${{ secrets.AZURE_CONTAINER_REGISTRY }} --query loginServer -o tsv)" >> $GITHUB_ENV

      - name: ACR Login
        run: az acr login --name ${{ secrets.AZURE_CONTAINER_REGISTRY }}

      - name: Setup Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Debug context contents
        run: |
          echo "Listing contents of ${{ matrix.context }}"
          ls -la ${{ matrix.context }}
          echo "Git submodule status:"
          git submodule status || true

      - name: Verify Dockerfile presence
        id: verify_dockerfile
        run: |
          if [ -f "${{ matrix.context }}/Dockerfile" ]; then
            echo "Dockerfile found at ${{ matrix.context }}/Dockerfile"
            echo "dockerfile_present=true" >> $GITHUB_OUTPUT
          else
            echo "WARNING: Dockerfile missing at ${{ matrix.context }}/Dockerfile. Skipping image build for ${{ matrix.image }}." >&2
            echo "dockerfile_present=false" >> $GITHUB_OUTPUT
          fi

      - name: Build & Push ${{ matrix.image }}
        uses: docker/build-push-action@v6
        if: steps.verify_dockerfile.outputs.dockerfile_present == 'true'
        with:
          context: ${{ matrix.context }}
          file: ${{ matrix.context }}/Dockerfile
          push: true
          tags: |
            ${{ env.ACR_LOGIN_SERVER }}/${{ matrix.image }}:${{ github.sha }}
            ${{ env.ACR_LOGIN_SERVER }}/${{ matrix.image }}:latest
          platforms: linux/amd64

  deploy-vm:
    name: Deploy to Azure VM (Docker Compose)
    needs: docker-build-push
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Resolve ACR login server
        run: |
          echo "ACR_LOGIN_SERVER=$(az acr show --name ${{ secrets.AZURE_CONTAINER_REGISTRY }} --query loginServer -o tsv)" >> $GITHUB_ENV

      - name: Ensure remote project dir
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.VM_HOST }}
          username: ${{ secrets.VM_SSH_USER }}
          key: ${{ secrets.VM_SSH_KEY }}
          port: ${{ secrets.VM_SSH_PORT }}
          script: |
            mkdir -p ~/proy17
            # Always remove the existing compose file/directory to force a fresh copy
            rm -rf ~/proy17/docker-compose.vm.yml
            
      - name: Copy Compose file to VM
        uses: appleboy/scp-action@v1
        with:
          host: ${{ secrets.VM_HOST }}
          username: ${{ secrets.VM_SSH_USER }}
          key: ${{ secrets.VM_SSH_KEY }}
          port: ${{ secrets.VM_SSH_PORT }}
          source: "deploy/docker-compose.vm.yml"
          target: "~/proy17/"
          strip_components: 1

      - name: Deploy on VM via SSH
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.VM_HOST }}
          username: ${{ secrets.VM_SSH_USER }}
          key: ${{ secrets.VM_SSH_KEY }}
          port: ${{ secrets.VM_SSH_PORT }}
          script: |
            set -e
            mkdir -p ~/proy17
            cd ~/proy17
            # Clean up incorrect directory from previous runs
            if [ -d "./docker-compose.vm.yml" ]; then
              echo "Found directory named docker-compose.vm.yml; removing to avoid compose error"
              rm -rf ./docker-compose.vm.yml
            fi
            # If the file landed inside a deploy/ folder, move it up
            if [ -f "./deploy/docker-compose.vm.yml" ]; then
              mv -f ./deploy/docker-compose.vm.yml ./docker-compose.vm.yml
            fi
            
            echo "==== Debug: Content of docker-compose.vm.yml ===="
            cat ./docker-compose.vm.yml
            echo "==============================================="
            
            ls -la
            echo "ACR_LOGIN_SERVER=${{ env.ACR_LOGIN_SERVER }}" > .env
            echo "TAG=${{ github.sha }}" >> .env
            # Optional SMTP for mail-service
            [ -n "${{ secrets.MAIL_HOST }}" ] && echo "MAIL_HOST=${{ secrets.MAIL_HOST }}" >> .env
            [ -n "${{ secrets.MAIL_PORT }}" ] && echo "MAIL_PORT=${{ secrets.MAIL_PORT }}" >> .env
            [ -n "${{ secrets.MAIL_USERNAME }}" ] && echo "MAIL_USERNAME=${{ secrets.MAIL_USERNAME }}" >> .env
            [ -n "${{ secrets.MAIL_PASSWORD }}" ] && echo "MAIL_PASSWORD=${{ secrets.MAIL_PASSWORD }}" >> .env

            # Login to ACR and pull images
            docker login ${{ env.ACR_LOGIN_SERVER }} -u "${{ secrets.ACR_USERNAME }}" -p "${{ secrets.ACR_PASSWORD }}"

            # Detect docker compose command
            if docker compose version >/dev/null 2>&1; then DC="docker compose"; else DC="docker-compose"; fi

            $DC --env-file .env -f ./docker-compose.vm.yml pull
            # Run compose up and collect diagnostics if it fails
            set +e
            echo "Starting docker compose up..."
            $DC --env-file .env -f ./docker-compose.vm.yml up -d --remove-orphans > compose_up_output.txt 2>&1
            UP_EXIT=$?
            set -e

            if [ "$UP_EXIT" -ne 0 ]; then
               echo "==== Docker Compose Up Failed ===="
               cat compose_up_output.txt
            fi

            echo "==== Docker Compose PS ===="
            $DC -f ./docker-compose.vm.yml ps || true

            echo "==== Docker Compose Config (resolved) ===="
            $DC -f ./docker-compose.vm.yml config || true        

            if [ "$UP_EXIT" -ne 0 ]; then
              echo "Compose up failed with exit code $UP_EXIT"
              exit "$UP_EXIT"
            fi